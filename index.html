<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>–î–Ω–µ–≤–Ω–∏–∫ –¢—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Raleway:wght@300;400;500;600;700&display=swap');

  :root {
    --bg: #0d0d0f;
    --surface: #16171c;
    --surface2: #1e1f26;
    --surface3: #252830;
    --accent: #e8ff47;
    --accent2: #47ffb8;
    --danger: #ff4757;
    --text: #f0f0f0;
    --text-dim: #8a8d9a;
    --border: #2e3040;
    --radius: 14px;
    --radius-sm: 8px;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }

  body {
    font-family: 'Raleway', sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* ‚îÄ‚îÄ SCREENS ‚îÄ‚îÄ */
  .screen { display: none; min-height: 100vh; flex-direction: column; }
  .screen.active { display: flex; }

  /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê FRONT SCREEN ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
  #screen-front {
    background: var(--bg);
  }

  .front-header {
    padding: 54px 24px 20px;
    background: var(--surface);
    border-bottom: 1px solid var(--border);
    position: sticky;
    top: 0;
    z-index: 10;
  }

  .front-header-top {
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    margin-bottom: 4px;
  }

  .front-header-buttons {
    display: flex;
    gap: 8px;
  }

  .btn-header-action {
    background: var(--surface2);
    border: 1px solid var(--border);
    color: var(--text-dim);
    font-size: 18px;
    width: 36px;
    height: 36px;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background 0.2s, color 0.2s;
  }

  .btn-header-action:hover {
    background: var(--surface3);
    color: var(--text);
  }

  .front-header h1 {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 36px;
    letter-spacing: 3px;
    color: var(--accent);
    line-height: 1;
  }

  .front-header .subtitle {
    font-size: 11px;
    color: var(--text-dim);
    letter-spacing: 2px;
    text-transform: uppercase;
    margin-top: 4px;
  }

  /* Calendar nav */
  .cal-nav {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 16px 24px;
    background: var(--surface);
    border-bottom: 1px solid var(--border);
    position: sticky;
    top: 108px;
    z-index: 10;
  }

  .cal-nav-btn {
    background: var(--surface2);
    border: 1px solid var(--border);
    color: var(--text);
    width: 36px;
    height: 36px;
    border-radius: 50%;
    font-size: 18px;
    cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    transition: background 0.2s;
  }

  .cal-nav-btn:hover { background: var(--surface3); }

  .cal-month-label {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 22px;
    letter-spacing: 2px;
    color: var(--text);
    text-transform: capitalize;
  }

  /* Week grid */
  .cal-weekdays {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    padding: 12px 16px 4px;
    background: var(--surface);
  }

  .cal-weekdays span {
    text-align: center;
    font-size: 10px;
    color: var(--text-dim);
    letter-spacing: 1px;
    text-transform: uppercase;
    font-weight: 600;
  }

  .cal-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 4px;
    padding: 8px 16px 16px;
    background: var(--surface);
  }

  .cal-day {
    aspect-ratio: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    border-radius: var(--radius-sm);
    cursor: default;
    position: relative;
    font-size: 13px;
    font-weight: 500;
    color: var(--text-dim);
  }

  .cal-day.has-training {
    cursor: pointer;
    background: var(--surface2);
    color: var(--text);
    border: 1px solid var(--border);
    transition: transform 0.15s, background 0.15s;
  }

  .cal-day.has-training:hover {
    background: var(--surface3);
    transform: scale(1.05);
  }

  .cal-day.today .day-num {
    background: var(--accent);
    color: #000;
    width: 26px;
    height: 26px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
  }

  .cal-day.has-training .day-num {
    color: var(--text);
    font-weight: 700;
  }

  .training-dot {
    width: 5px; height: 5px;
    background: var(--accent);
    border-radius: 50%;
    margin-top: 2px;
  }

  .cal-day.has-training.multiple-trainings .training-dot {
    background: var(--accent2);
    width: 7px; height: 7px;
  }

  /* Training list */
  .training-list-section {
    flex: 1;
    padding: 20px 16px 120px;
    overflow-y: auto;
  }

  .section-title {
    font-size: 11px;
    letter-spacing: 2px;
    text-transform: uppercase;
    color: var(--text-dim);
    margin-bottom: 12px;
    padding-left: 4px;
  }

  .training-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 16px;
    margin-bottom: 10px;
    cursor: pointer;
    transition: background 0.15s, border-color 0.15s;
  }

  .training-card:hover { background: var(--surface2); border-color: var(--accent); }

  .training-card-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 8px;
  }

  .training-card-name {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 20px;
    letter-spacing: 1px;
    color: var(--accent);
    line-height: 1;
  }

  .training-card-date {
    font-size: 11px;
    color: var(--text-dim);
    text-align: right;
  }

  .training-card-exercises {
    font-size: 12px;
    color: var(--text-dim);
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
  }

  .exercise-tag {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 20px;
    padding: 3px 10px;
    font-size: 11px;
    color: var(--text-dim);
  }

  .empty-state {
    text-align: center;
    padding: 40px 20px;
    color: var(--text-dim);
  }

  .empty-state .big-icon { font-size: 48px; margin-bottom: 12px; }
  .empty-state p { font-size: 14px; line-height: 1.6; }

  /* Start button */
  .front-bottom {
    position: fixed;
    bottom: 0; left: 0; right: 0;
    padding: 16px 20px calc(16px + env(safe-area-inset-bottom));
    background: linear-gradient(transparent, var(--bg) 40%);
    z-index: 20;
  }

  .btn-start {
    width: 100%;
    background: var(--accent);
    color: #000;
    border: none;
    border-radius: var(--radius);
    padding: 18px;
    font-family: 'Bebas Neue', sans-serif;
    font-size: 22px;
    letter-spacing: 3px;
    cursor: pointer;
    transition: transform 0.15s, opacity 0.15s;
    box-shadow: 0 4px 30px rgba(232,255,71,0.3);
  }

  .btn-start:active { transform: scale(0.97); opacity: 0.9; }

  /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê TRAINING SESSION SCREEN ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
  #screen-session {
    background: #111318;
  }

  .session-sticky-header {
    position: sticky;
    top: 0;
    z-index: 30;
    background: #0a0b0e;
    border-bottom: 2px solid var(--accent);
    padding: 48px 20px 14px;
  }

  .session-meta {
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    gap: 12px;
    margin-bottom: 12px;
  }

  .session-date-badge {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    padding: 6px 12px;
    font-size: 12px;
    color: var(--text-dim);
    white-space: nowrap;
    flex-shrink: 0;
  }

  .session-name-wrap { flex: 1; position: relative; }

  .session-name-input {
    width: 100%;
    background: transparent;
    border: none;
    border-bottom: 2px solid var(--border);
    color: var(--accent);
    font-family: 'Bebas Neue', sans-serif;
    font-size: 28px;
    letter-spacing: 2px;
    outline: none;
    padding: 4px 0;
    transition: border-color 0.2s;
  }

  .session-name-input:focus { border-color: var(--accent); }
  .session-name-input::placeholder { color: rgba(232,255,71,0.3); }

  .autocomplete-list {
    position: absolute;
    top: 100%; left: 0; right: 0;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    z-index: 100;
    max-height: 160px;
    overflow-y: auto;
    box-shadow: 0 8px 24px rgba(0,0,0,0.5);
    display: none;
  }

  .autocomplete-list.show { display: block; }

  .autocomplete-item {
    padding: 10px 14px;
    font-size: 14px;
    cursor: pointer;
    border-bottom: 1px solid var(--border);
    transition: background 0.15s;
    color: var(--text);
  }

  .autocomplete-item:last-child { border-bottom: none; }
  .autocomplete-item:hover { background: var(--surface3); }

  /* Session body */
  .session-body {
    padding: 16px 16px 220px;
    overflow-y: auto;
    flex: 1;
  }

  /* Exercise block */
  .exercise-block {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    margin-bottom: 14px;
    overflow: hidden;
  }

  .exercise-header {
    padding: 14px 16px 10px;
    display: flex;
    align-items: center;
    gap: 10px;
    border-bottom: 1px solid var(--border);
    background: var(--surface2);
  }

  .exercise-number {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 20px;
    color: var(--accent2);
    min-width: 24px;
  }

  .exercise-name-wrap { flex: 1; position: relative; }

  .exercise-name-input {
    width: 100%;
    background: transparent;
    border: none;
    border-bottom: 1px solid var(--border);
    color: var(--text);
    font-family: 'Raleway', sans-serif;
    font-size: 15px;
    font-weight: 600;
    outline: none;
    padding: 4px 0;
    transition: border-color 0.2s;
  }

  .exercise-name-input:focus { border-color: var(--accent2); }
  .exercise-name-input::placeholder { color: var(--text-dim); font-weight: 400; }

  .btn-remove-exercise {
    background: none;
    border: none;
    color: var(--danger);
    font-size: 20px;
    cursor: pointer;
    padding: 4px;
    opacity: 0.6;
    transition: opacity 0.15s;
  }

  .btn-remove-exercise:hover { opacity: 1; }

  /* Sets table */
  .sets-table { width: 100%; padding: 10px 12px 12px; }

  .sets-header {
    display: grid;
    grid-template-columns: 36px 1fr 1fr;
    gap: 8px;
    margin-bottom: 6px;
    padding: 0 4px;
  }

  .sets-header span {
    font-size: 9px;
    letter-spacing: 1.5px;
    text-transform: uppercase;
    color: var(--text-dim);
    text-align: center;
  }

  .sets-header span:first-child { text-align: center; }

  .set-row {
    display: grid;
    grid-template-columns: 36px 1fr 1fr;
    gap: 8px;
    margin-bottom: 6px;
    align-items: center;
  }

  .set-num {
    text-align: center;
    font-family: 'Bebas Neue', sans-serif;
    font-size: 18px;
    color: var(--text-dim);
  }

  .set-input {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    color: var(--text);
    font-family: 'Raleway', sans-serif;
    font-size: 16px;
    font-weight: 600;
    padding: 10px;
    text-align: center;
    outline: none;
    transition: border-color 0.2s;
    width: 100%;
    -moz-appearance: textfield;
  }

  .set-input::-webkit-outer-spin-button,
  .set-input::-webkit-inner-spin-button { -webkit-appearance: none; }

  .set-input:focus { border-color: var(--accent2); }
  .set-input::placeholder { color: var(--border); font-size: 13px; }

  /* Session bottom buttons */
  .session-bottom {
    position: fixed;
    bottom: 0; left: 0; right: 0;
    padding: 12px 16px calc(12px + env(safe-area-inset-bottom));
    background: linear-gradient(transparent, #0a0b0e 30%);
    z-index: 20;
  }

  .btn-new-exercise {
    width: 100%;
    background: var(--surface2);
    border: 2px dashed var(--border);
    color: var(--text-dim);
    border-radius: var(--radius);
    padding: 14px;
    font-family: 'Raleway', sans-serif;
    font-size: 14px;
    font-weight: 600;
    letter-spacing: 1px;
    cursor: pointer;
    transition: border-color 0.2s, color 0.2s;
    margin-bottom: 10px;
  }

  .btn-new-exercise:hover { border-color: var(--accent2); color: var(--accent2); }

  .session-actions {
    display: grid;
    grid-template-columns: 1fr 1.6fr;
    gap: 10px;
  }

  .btn-note {
    background: var(--surface2);
    border: 1px solid var(--border);
    color: var(--text-dim);
    border-radius: var(--radius);
    padding: 14px;
    font-family: 'Raleway', sans-serif;
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    transition: background 0.2s;
    text-align: center;
  }

  .btn-note:hover { background: var(--surface3); }

  .btn-finish {
    background: var(--accent);
    border: none;
    color: #000;
    border-radius: var(--radius);
    padding: 14px;
    font-family: 'Bebas Neue', sans-serif;
    font-size: 20px;
    letter-spacing: 2px;
    cursor: pointer;
    transition: transform 0.15s, opacity 0.15s;
    box-shadow: 0 4px 20px rgba(232,255,71,0.25);
  }

  .btn-finish:active { transform: scale(0.97); }

  /* Bodyweight field */
  .bodyweight-area {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 14px;
    margin-bottom: 14px;
  }

  .bodyweight-area label {
    font-size: 10px;
    letter-spacing: 2px;
    text-transform: uppercase;
    color: var(--text-dim);
    display: block;
    margin-bottom: 8px;
  }

  .bodyweight-input {
    width: 100%;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    color: var(--text);
    font-family: 'Raleway', sans-serif;
    font-size: 16px;
    font-weight: 600;
    padding: 10px 12px;
    outline: none;
    text-align: center;
  }

  .bodyweight-input:focus { border-color: var(--accent2); }

  /* Note area */
  .note-area {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 14px;
    margin-bottom: 14px;
    display: none;
  }

  .note-area.show { display: block; }

  .note-area label {
    font-size: 10px;
    letter-spacing: 2px;
    text-transform: uppercase;
    color: var(--text-dim);
    display: block;
    margin-bottom: 8px;
  }

  .note-textarea {
    width: 100%;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    color: var(--text);
    font-family: 'Raleway', sans-serif;
    font-size: 14px;
    padding: 10px 12px;
    outline: none;
    resize: none;
    min-height: 80px;
    line-height: 1.5;
  }

  .note-textarea:focus { border-color: var(--accent2); }

  /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê POPUP MODAL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
  .modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.7);
    z-index: 50;
    display: none;
    align-items: flex-end;
    justify-content: center;
    backdrop-filter: blur(4px);
  }

  .modal-overlay.show { display: flex; }

  .modal-sheet {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 24px 24px 0 0;
    width: 100%;
    max-width: 480px;
    padding: 20px 20px calc(28px + env(safe-area-inset-bottom));
    animation: slideUp 0.25s ease;
  }

  @keyframes slideUp {
    from { transform: translateY(100%); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
  }

  .modal-handle {
    width: 40px; height: 4px;
    background: var(--border);
    border-radius: 2px;
    margin: 0 auto 16px;
  }

  .modal-title {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 22px;
    letter-spacing: 2px;
    color: var(--accent);
    margin-bottom: 6px;
  }

  .modal-subtitle {
    font-size: 12px;
    color: var(--text-dim);
    margin-bottom: 20px;
  }

  .modal-actions { display: flex; flex-direction: column; gap: 10px; }

  .modal-btn {
    width: 100%;
    border-radius: var(--radius);
    padding: 15px;
    font-family: 'Raleway', sans-serif;
    font-size: 15px;
    font-weight: 600;
    cursor: pointer;
    transition: opacity 0.15s;
    border: none;
    text-align: center;
  }

  .modal-btn:active { opacity: 0.8; }
  .modal-btn.edit { background: var(--surface2); color: var(--text); border: 1px solid var(--border); }
  .modal-btn.share { background: var(--accent2); color: #000; }
  .modal-btn.delete { background: var(--danger); color: #fff; }
  .modal-btn.cancel { background: transparent; color: var(--text-dim); border: 1px solid var(--border); }

  /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SHARE MODAL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
  .share-preview {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 14px 16px;
    margin-bottom: 14px;
    font-size: 13px;
    line-height: 1.6;
    color: var(--text-dim);
  }
  .share-preview strong { color: var(--text); font-weight: 600; }

  .btn-copy {
    width: 100%;
    background: var(--accent2);
    border: none;
    color: #000;
    border-radius: var(--radius);
    padding: 14px;
    font-family: 'Bebas Neue', sans-serif;
    font-size: 18px;
    letter-spacing: 2px;
    cursor: pointer;
    margin-bottom: 10px;
  }

  .btn-open-link {
    width: 100%;
    background: var(--surface2);
    border: 1px solid var(--accent2);
    color: var(--accent2);
    border-radius: var(--radius);
    padding: 14px;
    font-family: 'Bebas Neue', sans-serif;
    font-size: 18px;
    letter-spacing: 2px;
    cursor: pointer;
    margin-bottom: 10px;
    text-align: center;
  }

  /* Toast */
  .toast {
    position: fixed;
    bottom: 100px;
    left: 50%;
    transform: translateX(-50%);
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 12px 24px;
    font-size: 13px;
    color: var(--text);
    z-index: 999;
    display: none;
    white-space: nowrap;
  }

  .toast.show { display: block; animation: fadeInOut 2s forwards; }

  @keyframes fadeInOut {
    0% { opacity: 0; transform: translateX(-50%) translateY(10px); }
    15% { opacity: 1; transform: translateX(-50%) translateY(0); }
    70% { opacity: 1; }
    100% { opacity: 0; }
  }

  /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SHARE VIEW SCREEN ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
  #screen-share { background: var(--bg); }

  .share-hero {
    background: var(--surface);
    border-bottom: 3px solid var(--accent);
    padding: 52px 24px 24px;
  }

  .share-hero-label {
    font-size: 10px;
    letter-spacing: 3px;
    text-transform: uppercase;
    color: var(--text-dim);
    margin-bottom: 8px;
  }

  .share-hero-name {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 44px;
    letter-spacing: 3px;
    color: var(--accent);
    line-height: 1;
    margin-bottom: 8px;
  }

  .share-hero-date {
    font-size: 14px;
    color: var(--text-dim);
  }

  .share-body {
    padding: 20px 16px 60px;
  }

  .share-ex-block {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    margin-bottom: 12px;
    overflow: hidden;
  }

  .share-ex-title {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 16px;
    background: var(--surface2);
    font-size: 15px;
    font-weight: 600;
    border-bottom: 1px solid var(--border);
  }

  .share-ex-num {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 20px;
    color: var(--accent2);
    min-width: 22px;
  }

  .share-sets-header {
    display: grid;
    grid-template-columns: 44px 1fr 1fr;
    padding: 8px 16px 4px;
    background: var(--surface2);
  }

  .share-sets-header span {
    font-size: 9px;
    letter-spacing: 1.5px;
    text-transform: uppercase;
    color: var(--text-dim);
    font-weight: 600;
  }

  .share-set-row {
    display: grid;
    grid-template-columns: 44px 1fr 1fr;
    padding: 10px 16px;
    border-top: 1px solid var(--border);
    align-items: center;
  }

  .share-set-row:hover { background: var(--surface2); }

  .share-set-num {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 18px;
    color: var(--text-dim);
  }

  .share-set-weight {
    font-size: 16px;
    font-weight: 600;
    color: var(--accent2);
  }

  .share-set-reps {
    font-size: 15px;
    font-weight: 500;
    color: var(--text);
  }

  .share-note-block {
    background: var(--surface);
    border: 1px solid var(--border);
    border-left: 3px solid var(--accent2);
    border-radius: var(--radius);
    padding: 14px 16px;
    margin-top: 4px;
  }

  .share-note-label {
    font-size: 10px;
    letter-spacing: 2px;
    text-transform: uppercase;
    color: var(--text-dim);
    margin-bottom: 8px;
  }

  .share-note-text {
    font-size: 14px;
    line-height: 1.6;
    color: var(--text);
  }

  .share-footer {
    text-align: center;
    padding: 16px;
    font-size: 11px;
    color: var(--text-dim);
    letter-spacing: 1px;
    border-top: 1px solid var(--border);
    margin-top: 8px;
  }

  .share-back-btn {
    display: flex;
    align-items: center;
    gap: 8px;
    background: none;
    border: none;
    color: var(--text-dim);
    font-family: 'Raleway', sans-serif;
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    padding: 0;
    margin-bottom: 16px;
    letter-spacing: 1px;
  }

  .share-back-btn:hover { color: var(--text); }

  /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SETTINGS SCREEN ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
  #screen-settings { background: var(--bg); }

  .settings-header {
    padding: 52px 24px 24px;
    background: var(--surface);
    border-bottom: 2px solid var(--accent);
  }

  .settings-back {
    display: flex;
    align-items: center;
    gap: 8px;
    background: none;
    border: none;
    color: var(--text-dim);
    font-family: 'Raleway', sans-serif;
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    padding: 0;
    margin-bottom: 16px;
    letter-spacing: 1px;
  }

  .settings-back:hover { color: var(--text); }

  .settings-title {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 36px;
    letter-spacing: 3px;
    color: var(--accent);
    line-height: 1;
  }

  .settings-body {
    padding: 24px 20px 80px;
  }

  .settings-section {
    margin-bottom: 32px;
  }

  .settings-section-title {
    font-size: 11px;
    letter-spacing: 2px;
    text-transform: uppercase;
    color: var(--text-dim);
    margin-bottom: 12px;
    font-weight: 600;
  }

  .settings-input-group {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 16px;
  }

  .settings-label {
    font-size: 12px;
    color: var(--text-dim);
    margin-bottom: 8px;
    display: block;
  }

  .settings-input {
    width: 100%;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    color: var(--text);
    font-family: 'Raleway', sans-serif;
    font-size: 16px;
    font-weight: 500;
    padding: 12px 14px;
    outline: none;
    transition: border-color 0.2s;
  }

  .settings-input:focus { border-color: var(--accent); }

  .settings-button {
    width: 100%;
    background: var(--surface);
    border: 1px solid var(--border);
    color: var(--text);
    border-radius: var(--radius);
    padding: 16px;
    font-family: 'Raleway', sans-serif;
    font-size: 15px;
    font-weight: 600;
    cursor: pointer;
    transition: background 0.2s, border-color 0.2s;
    margin-bottom: 10px;
    text-align: left;
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .settings-button:hover {
    background: var(--surface2);
    border-color: var(--accent2);
  }

  .settings-button-icon {
    font-size: 20px;
    width: 32px;
    text-align: center;
  }

  .settings-button-label {
    flex: 1;
  }

  .settings-button-arrow {
    color: var(--text-dim);
    font-size: 14px;
  }

  /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê REST TIMER ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
  .rest-timer {
    position: fixed;
    bottom: 100px;
    left: 50%;
    transform: translateX(-50%);
    background: var(--surface);
    border: 2px solid var(--accent2);
    border-radius: var(--radius);
    padding: 16px 24px;
    box-shadow: 0 8px 32px rgba(0,0,0,0.6);
    z-index: 100;
    display: none;
    flex-direction: column;
    align-items: center;
    gap: 12px;
    min-width: 200px;
  }

  .rest-timer.show { display: flex; }

  .rest-timer-label {
    font-size: 11px;
    letter-spacing: 2px;
    text-transform: uppercase;
    color: var(--text-dim);
  }

  .rest-timer-time {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 48px;
    letter-spacing: 2px;
    color: var(--accent2);
    line-height: 1;
  }

  .rest-timer-controls {
    display: flex;
    gap: 8px;
  }

  .rest-timer-btn {
    background: var(--surface2);
    border: 1px solid var(--border);
    color: var(--text);
    padding: 6px 16px;
    border-radius: var(--radius-sm);
    font-size: 12px;
    font-weight: 600;
    cursor: pointer;
    transition: background 0.2s;
  }

  .rest-timer-btn:hover { background: var(--surface3); }

  /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PR BADGE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
  .pr-badge {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    background: linear-gradient(135deg, #ffd700, #ffed4e);
    color: #000;
    font-size: 10px;
    font-weight: 700;
    padding: 3px 8px;
    border-radius: 12px;
    letter-spacing: 0.5px;
    margin-left: 6px;
    animation: prPulse 1.5s ease infinite;
  }

  @keyframes prPulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.05); }
  }

  /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PROGRESS MODAL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
  .progress-modal {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.85);
    z-index: 60;
    display: none;
    align-items: center;
    justify-content: center;
    padding: 20px;
    backdrop-filter: blur(4px);
  }

  .progress-modal.show { display: flex; }

  .progress-sheet {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    width: 100%;
    max-width: 500px;
    max-height: 80vh;
    overflow-y: auto;
    padding: 24px;
  }

  .progress-header {
    margin-bottom: 20px;
  }

  .progress-title {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 24px;
    letter-spacing: 2px;
    color: var(--accent);
    margin-bottom: 4px;
  }

  .progress-subtitle {
    font-size: 12px;
    color: var(--text-dim);
  }

  .progress-stats {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
    margin-bottom: 20px;
  }

  .progress-stat {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    padding: 12px;
  }

  .progress-stat-label {
    font-size: 10px;
    letter-spacing: 1.5px;
    text-transform: uppercase;
    color: var(--text-dim);
    margin-bottom: 4px;
  }

  .progress-stat-value {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 28px;
    letter-spacing: 1px;
    color: var(--accent2);
    line-height: 1;
  }

  .progress-chart {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    padding: 16px;
    margin-bottom: 16px;
  }

  .progress-chart-title {
    font-size: 11px;
    letter-spacing: 1.5px;
    text-transform: uppercase;
    color: var(--text-dim);
    margin-bottom: 12px;
  }

  .progress-chart-canvas {
    width: 100%;
    height: 200px;
  }

  .progress-history {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    padding: 12px;
  }

  .progress-history-title {
    font-size: 11px;
    letter-spacing: 1.5px;
    text-transform: uppercase;
    color: var(--text-dim);
    margin-bottom: 10px;
  }

  .progress-history-item {
    display: grid;
    grid-template-columns: 80px 1fr 1fr;
    gap: 8px;
    padding: 8px 0;
    border-bottom: 1px solid var(--border);
    font-size: 13px;
  }

  .progress-history-item:last-child { border-bottom: none; }

  .progress-history-date {
    color: var(--text-dim);
    font-size: 11px;
  }

  .progress-history-weight {
    color: var(--accent2);
    font-weight: 600;
  }

  .progress-history-reps {
    color: var(--text);
  }

  .progress-close {
    width: 100%;
    background: var(--surface2);
    border: 1px solid var(--border);
    color: var(--text);
    border-radius: var(--radius);
    padding: 12px;
    font-family: 'Raleway', sans-serif;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    margin-top: 16px;
  }
</style>
</head>
<body>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê FRONT SCREEN ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="screen-front" class="screen active">
  <div class="front-header">
    <div class="front-header-top">
      <div>
        <h1 id="front-header-title">–î–ù–ï–í–ù–ò–ö</h1>
        <div class="subtitle">–¢—Ä–µ–Ω–∏—Ä–æ–≤–æ—á–Ω—ã–π –∂—É—Ä–Ω–∞–ª</div>
      </div>
      <div class="front-header-buttons">
        <button class="btn-header-action" id="btn-settings" title="–ù–∞—Å—Ç—Ä–æ–π–∫–∏">‚öô</button>
      </div>
    </div>
  </div>

  <div class="cal-nav">
    <button class="cal-nav-btn" id="btn-prev-month">‚Äπ</button>
    <div class="cal-month-label" id="cal-month-label">–Ø–Ω–≤–∞—Ä—å 2025</div>
    <button class="cal-nav-btn" id="btn-next-month">‚Ä∫</button>
  </div>

  <div class="cal-weekdays">
    <span>–ü–Ω</span><span>–í—Ç</span><span>–°—Ä</span>
    <span>–ß—Ç</span><span>–ü—Ç</span><span>–°–±</span><span>–í—Å</span>
  </div>
  <div class="cal-grid" id="cal-grid"></div>

  <div class="training-list-section">
    <div class="section-title" id="list-section-title">–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ –º–µ—Å—è—Ü–∞</div>
    <div id="training-list-container"></div>
  </div>

  <div class="front-bottom">
    <button class="btn-start" id="btn-start-training">Ôºã –ù–ê–ß–ê–¢–¨ –¢–†–ï–ù–ò–†–û–í–ö–£</button>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SESSION SCREEN ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="screen-session" class="screen">
  <div class="session-sticky-header">
    <div class="session-meta">
      <div class="session-date-badge" id="session-date-badge">‚Äî</div>
      <div class="session-name-wrap">
        <input type="text" class="session-name-input" id="session-name-input"
               placeholder="–ù–ê–ó–í–ê–ù–ò–ï –¢–†–ï–ù–ò–†–û–í–ö–ò" autocomplete="off">
        <div class="autocomplete-list" id="session-name-ac"></div>
      </div>
    </div>
  </div>

  <div class="session-body" id="session-body">
    <div id="exercises-container"></div>

    <div class="bodyweight-area">
      <label>–í–µ—Å —Ç–µ–ª–∞ (–∫–≥)</label>
      <input type="number" class="bodyweight-input" id="bodyweight-input" placeholder="‚Äî" inputmode="decimal" min="0" step="0.1">
    </div>

    <div class="note-area" id="note-area">
      <label>–ó–∞–º–µ—Ç–∫–∞</label>
      <textarea class="note-textarea" id="note-textarea" placeholder="–î–æ–±–∞–≤—å—Ç–µ –∑–∞–º–µ—Ç–∫—É –∫ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–µ..."></textarea>
    </div>
  </div>

  <div class="session-bottom">
    <button class="btn-new-exercise" id="btn-new-exercise">Ôºã –ù–û–í–û–ï –£–ü–†–ê–ñ–ù–ï–ù–ò–ï</button>
    <div class="session-actions">
      <button class="btn-note" id="btn-add-note">üìù –ó–ê–ú–ï–¢–ö–ê</button>
      <button class="btn-finish" id="btn-finish-training">–ó–ê–í–ï–†–®–ò–¢–¨</button>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SETTINGS SCREEN ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="screen-settings" class="screen">
  <div class="settings-header">
    <button class="settings-back" id="settings-back-btn">‚Üê –ù–∞–∑–∞–¥</button>
    <div class="settings-title">–ù–ê–°–¢–†–û–ô–ö–ò</div>
  </div>
  <div class="settings-body">
    <div class="settings-section">
      <div class="settings-section-title">–ü—Ä–æ—Ñ–∏–ª—å</div>
      <div class="settings-input-group">
        <label class="settings-label">–í–∞—à–µ –∏–º—è</label>
        <input type="text" class="settings-input" id="settings-user-name" placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è">
      </div>
    </div>

    <div class="settings-section">
      <div class="settings-section-title">–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞</div>
      <div class="settings-input-group">
        <label class="settings-label">–í—Ä–µ–º—è –æ—Ç–¥—ã—Ö–∞ (—Å–µ–∫—É–Ω–¥—ã)</label>
        <input type="number" class="settings-input" id="settings-rest-time" placeholder="90" min="30" max="600" step="10">
      </div>
    </div>

    <div class="settings-section">
      <div class="settings-section-title">–î–∞–Ω–Ω—ã–µ</div>
      <button class="settings-button" id="settings-export-btn">
        <span class="settings-button-icon">‚Üë</span>
        <span class="settings-button-label">–≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö</span>
        <span class="settings-button-arrow">‚Ä∫</span>
      </button>
      <button class="settings-button" id="settings-import-btn">
        <span class="settings-button-icon">‚Üì</span>
        <span class="settings-button-label">–ò–º–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö</span>
        <span class="settings-button-arrow">‚Ä∫</span>
      </button>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê TRAINING POPUP MODAL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="modal-overlay" id="modal-training">
  <div class="modal-sheet">
    <div class="modal-handle"></div>
    <div class="modal-title" id="modal-training-name">‚Äî</div>
    <div class="modal-subtitle" id="modal-training-date">‚Äî</div>
    <div class="modal-actions">
      <button class="modal-btn edit" id="modal-btn-edit">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
      <button class="modal-btn share" id="modal-btn-share">‚Üó –ü–æ–¥–µ–ª–∏—Ç—å—Å—è</button>
      <button class="modal-btn delete" id="modal-btn-delete">üóë –£–¥–∞–ª–∏—Ç—å</button>
      <button class="modal-btn cancel" id="modal-btn-cancel">–û—Ç–º–µ–Ω–∞</button>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SHARE VIEW SCREEN ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="screen-share" class="screen">
  <div class="share-hero">
    <div class="share-hero-label">–ó–∞–ø–∏—Å—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏</div>
    <div class="share-hero-name" id="sv-name">‚Äî</div>
    <div class="share-hero-date" id="sv-date">‚Äî</div>
  </div>
  <div class="share-body">
    <button class="share-back-btn" id="sv-back-btn">‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –¥–Ω–µ–≤–Ω–∏–∫</button>
    <div id="sv-exercises"></div>
    <div class="share-note-block" id="sv-note-block" style="display:none">
      <div class="share-note-label">üìù –ó–∞–º–µ—Ç–∫–∞</div>
      <div class="share-note-text" id="sv-note-text"></div>
    </div>
    <div class="share-footer">üèãÔ∏è –î–Ω–µ–≤–Ω–∏–∫ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫</div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SHARE MODAL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="modal-overlay" id="modal-share">
  <div class="modal-sheet">
    <div class="modal-handle"></div>
    <div class="modal-title">–ü–û–î–ï–õ–ò–¢–¨–°–Ø</div>
    <div class="modal-subtitle">–°—Å—ã–ª–∫–∞ –Ω–∞ –∑–∞–ø–∏—Å—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏</div>
    <div class="share-preview" id="share-preview"></div>
    <button class="btn-open-link" id="btn-open-link">‚Üó –û–¢–ö–†–´–¢–¨ –°–¢–†–ê–ù–ò–¶–£</button>
    <button class="btn-copy" id="btn-copy-share">–°–ö–û–ü–ò–†–û–í–ê–¢–¨ –°–°–´–õ–ö–£</button>
    <button class="modal-btn cancel" id="modal-share-cancel">–ó–∞–∫—Ä—ã—Ç—å</button>
  </div>
</div>

<!-- Rest Timer -->
<div class="rest-timer" id="rest-timer">
  <div class="rest-timer-label">–û—Ç–¥—ã—Ö</div>
  <div class="rest-timer-time" id="rest-timer-time">1:30</div>
  <div class="rest-timer-controls">
    <button class="rest-timer-btn" id="rest-timer-skip">–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å</button>
    <button class="rest-timer-btn" id="rest-timer-add">+30—Å</button>
  </div>
</div>

<!-- Progress Modal -->
<div class="progress-modal" id="progress-modal">
  <div class="progress-sheet">
    <div class="progress-header">
      <div class="progress-title" id="progress-ex-name">‚Äî</div>
      <div class="progress-subtitle">–ò—Å—Ç–æ—Ä–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞</div>
    </div>
    
    <div class="progress-stats">
      <div class="progress-stat">
        <div class="progress-stat-label">–õ—É—á—à–∏–π –≤–µ—Å</div>
        <div class="progress-stat-value" id="progress-best-weight">‚Äî</div>
      </div>
      <div class="progress-stat">
        <div class="progress-stat-label">–ë–æ–ª—å—à–µ –≤—Å–µ–≥–æ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–π</div>
        <div class="progress-stat-value" id="progress-best-reps">‚Äî</div>
      </div>
    </div>

    <div class="progress-chart">
      <div class="progress-chart-title">–ì—Ä–∞—Ñ–∏–∫ –≤–µ—Å–∞</div>
      <canvas class="progress-chart-canvas" id="progress-chart-weight"></canvas>
    </div>

    <div class="progress-chart">
      <div class="progress-chart-title">–ì—Ä–∞—Ñ–∏–∫ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–π</div>
      <canvas class="progress-chart-canvas" id="progress-chart-reps"></canvas>
    </div>

    <div class="progress-history">
      <div class="progress-history-title">–ü–æ—Å–ª–µ–¥–Ω–∏–µ 10 –ø–æ–¥—Ö–æ–¥–æ–≤</div>
      <div id="progress-history-list"></div>
    </div>

    <button class="progress-close" id="progress-close">–ó–∞–∫—Ä—ã—Ç—å</button>
  </div>
</div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STORAGE (uses window.storage if available, else localStorage)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

const STORAGE_KEY = 'gym-diary-v2';

async function loadData() {
  try {
    if (window.storage) {
      const r = await window.storage.get(STORAGE_KEY);
      return r ? JSON.parse(r.value) : defaultData();
    }
  } catch(e) {}
  try {
    const raw = localStorage.getItem(STORAGE_KEY);
    return raw ? JSON.parse(raw) : defaultData();
  } catch(e) { return defaultData(); }
}

async function saveData(data) {
  try {
    if (window.storage) {
      await window.storage.set(STORAGE_KEY, JSON.stringify(data));
      return;
    }
  } catch(e) {}
  try { localStorage.setItem(STORAGE_KEY, JSON.stringify(data)); } catch(e) {}
}

function defaultData() {
  return { trainings: [], trainingNames: [], exerciseNames: [], userName: '', restTimer: 90 };
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let appData = defaultData();
let currentViewDate = new Date();
let sessionState = null; // { id, isEdit, trainingId }

const MONTHS_RU = ['–Ø–Ω–≤–∞—Ä—å','–§–µ–≤—Ä–∞–ª—å','–ú–∞—Ä—Ç','–ê–ø—Ä–µ–ª—å','–ú–∞–π','–ò—é–Ω—å',
                   '–ò—é–ª—å','–ê–≤–≥—É—Å—Ç','–°–µ–Ω—Ç—è–±—Ä—å','–û–∫—Ç—è–±—Ä—å','–ù–æ—è–±—Ä—å','–î–µ–∫–∞–±—Ä—å'];

const MONTHS_RU_GEN = ['—è–Ω–≤–∞—Ä—è','—Ñ–µ–≤—Ä–∞–ª—è','–º–∞—Ä—Ç–∞','–∞–ø—Ä–µ–ª—è','–º–∞—è','–∏—é–Ω—è',
                        '–∏—é–ª—è','–∞–≤–≥—É—Å—Ç–∞','—Å–µ–Ω—Ç—è–±—Ä—è','–æ–∫—Ç—è–±—Ä—è','–Ω–æ—è–±—Ä—è','–¥–µ–∫–∞–±—Ä—è'];

const WEEKDAYS_RU = ['–ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫','–≤—Ç–æ—Ä–Ω–∏–∫','—Å—Ä–µ–¥–∞','—á–µ—Ç–≤–µ—Ä–≥','–ø—è—Ç–Ω–∏—Ü–∞','—Å—É–±–±–æ—Ç–∞','–≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ'];

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// UTILS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function uid() { return Date.now().toString(36) + Math.random().toString(36).substr(2,5); }

function formatDateFull(dateStr) {
  const d = new Date(dateStr + 'T00:00:00');
  const wd = (d.getDay() + 6) % 7;
  return `${d.getDate()} ${MONTHS_RU_GEN[d.getMonth()]} ${d.getFullYear()}, ${WEEKDAYS_RU[wd]}`;
}

function todayStr() {
  const d = new Date();
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
}

function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.remove('show');
  void t.offsetWidth;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2200);
}

function showScreen(id) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById('screen-' + id).classList.add('active');
  window.scrollTo(0, 0);
  if (id === 'front') renderCalendar();
}

function addToNameList(arr, name) {
  name = name.trim();
  if (!name) return arr;
  if (!arr.includes(name)) arr.unshift(name);
  return arr.slice(0, 40);
}

function updateHeaderTitle() {
  const header = document.getElementById('front-header-title');
  if (appData.userName && appData.userName.trim()) {
    header.textContent = `–î–ù–ï–í–ù–ò–ö ‚Äî ${appData.userName.toUpperCase()}`;
  } else {
    header.textContent = '–î–ù–ï–í–ù–ò–ö';
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FRONT SCREEN ‚Äì CALENDAR
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderCalendar() {
  updateHeaderTitle();
  const y = currentViewDate.getFullYear();
  const m = currentViewDate.getMonth();
  document.getElementById('cal-month-label').textContent = `${MONTHS_RU[m]} ${y}`;

  const firstDay = new Date(y, m, 1);
  const lastDay  = new Date(y, m+1, 0);
  const startOffset = (firstDay.getDay() + 6) % 7; // Monday=0

  const grid = document.getElementById('cal-grid');
  grid.innerHTML = '';

  const todayS = todayStr();

  // Group trainings by date for this month
  const byDate = {};
  appData.trainings.forEach(t => {
    if (t.date.startsWith(`${y}-${String(m+1).padStart(2,'0')}`)) {
      if (!byDate[t.date]) byDate[t.date] = [];
      byDate[t.date].push(t);
    }
  });

  // Blank cells before first day
  for (let i = 0; i < startOffset; i++) {
    grid.appendChild(Object.assign(document.createElement('div'), { className: 'cal-day' }));
  }

  for (let d = 1; d <= lastDay.getDate(); d++) {
    const dateStr = `${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    const cell = document.createElement('div');
    cell.className = 'cal-day';
    if (dateStr === todayS) cell.classList.add('today');

    const dayNum = document.createElement('div');
    dayNum.className = 'day-num';
    dayNum.textContent = d;
    cell.appendChild(dayNum);

    if (byDate[dateStr] && byDate[dateStr].length > 0) {
      cell.classList.add('has-training');
      if (byDate[dateStr].length > 1) cell.classList.add('multiple-trainings');
      const dot = document.createElement('div');
      dot.className = 'training-dot';
      cell.appendChild(dot);
      cell.addEventListener('click', () => scrollToDateInList(dateStr));
    }
    grid.appendChild(cell);
  }

  renderTrainingList();
}

function renderTrainingList() {
  const y = currentViewDate.getFullYear();
  const m = currentViewDate.getMonth();
  const prefix = `${y}-${String(m+1).padStart(2,'0')}`;

  const monthTrainings = appData.trainings
    .filter(t => t.date.startsWith(prefix))
    .sort((a,b) => b.date.localeCompare(a.date));

  const container = document.getElementById('training-list-container');
  const title = document.getElementById('list-section-title');
  title.textContent = `–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ ‚Äî ${MONTHS_RU[m]} ${y}`;

  if (monthTrainings.length === 0) {
    container.innerHTML = `<div class="empty-state">
      <div class="big-icon">üèãÔ∏è</div>
      <p>–í —ç—Ç–æ–º –º–µ—Å—è—Ü–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ –Ω–µ—Ç.<br>–ù–∞–∂–º–∏—Ç–µ ¬´–ù–∞—á–∞—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É¬ª!</p>
    </div>`;
    return;
  }

  container.innerHTML = '';
  monthTrainings.forEach(t => {
    const card = document.createElement('div');
    card.className = 'training-card';
    card.dataset.id = t.id;

    const exTags = (t.exercises || []).slice(0, 4).map(e =>
      `<span class="exercise-tag">${e.name || '‚Äî'}</span>`
    ).join('') + ((t.exercises||[]).length > 4 ? `<span class="exercise-tag">+${t.exercises.length-4}</span>` : '');

    const bodyweightTag = t.bodyweight ? `<span class="exercise-tag">‚öñÔ∏è ${t.bodyweight} –∫–≥</span>` : '';

    card.innerHTML = `
      <div class="training-card-header">
        <div class="training-card-name">${t.name || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è'}</div>
        <div class="training-card-date">${formatDateFull(t.date)}</div>
      </div>
      <div class="training-card-exercises">${exTags || '<span style="font-size:11px;color:var(--text-dim)">–£–ø—Ä–∞–∂–Ω–µ–Ω–∏–π –Ω–µ—Ç</span>'} ${bodyweightTag}</div>`;

    card.addEventListener('click', () => openTrainingModal(t.id));
    container.appendChild(card);
  });
}

function scrollToDateInList(dateStr) {
  const card = document.querySelector(`.training-card[data-id]`);
  // find card for that date
  const training = appData.trainings.find(t => t.date === dateStr);
  if (!training) return;
  const el = document.querySelector(`.training-card[data-id="${training.id}"]`);
  if (el) el.scrollIntoView({ behavior: 'smooth', block: 'center' });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TRAINING MODAL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let activeModalTrainingId = null;

function openTrainingModal(id) {
  const t = appData.trainings.find(x => x.id === id);
  if (!t) return;
  activeModalTrainingId = id;
  document.getElementById('modal-training-name').textContent = t.name || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è';
  document.getElementById('modal-training-date').textContent = formatDateFull(t.date);
  document.getElementById('modal-training').classList.add('show');
}

document.getElementById('modal-btn-cancel').addEventListener('click', () => {
  document.getElementById('modal-training').classList.remove('show');
});

document.getElementById('modal-btn-edit').addEventListener('click', () => {
  document.getElementById('modal-training').classList.remove('show');
  const t = appData.trainings.find(x => x.id === activeModalTrainingId);
  if (t) openSession(true, t);
});

document.getElementById('modal-btn-delete').addEventListener('click', () => {
  appData.trainings = appData.trainings.filter(x => x.id !== activeModalTrainingId);
  saveData(appData);
  document.getElementById('modal-training').classList.remove('show');
  renderCalendar();
  showToast('–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ —É–¥–∞–ª–µ–Ω–∞');
});

document.getElementById('modal-btn-share').addEventListener('click', () => {
  document.getElementById('modal-training').classList.remove('show');
  const t = appData.trainings.find(x => x.id === activeModalTrainingId);
  if (t) openShareModal(t);
});

// close on overlay click
document.getElementById('modal-training').addEventListener('click', function(e) {
  if (e.target === this) this.classList.remove('show');
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SHARE MODAL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚îÄ‚îÄ SHARE SCREEN RENDERER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const MONTHS_GEN_SHARE = ['—è–Ω–≤–∞—Ä—è','—Ñ–µ–≤—Ä–∞–ª—è','–º–∞—Ä—Ç–∞','–∞–ø—Ä–µ–ª—è','–º–∞—è','–∏—é–Ω—è','–∏—é–ª—è','–∞–≤–≥—É—Å—Ç–∞','—Å–µ–Ω—Ç—è–±—Ä—è','–æ–∫—Ç—è–±—Ä—è','–Ω–æ—è–±—Ä—è','–¥–µ–∫–∞–±—Ä—è'];
const WDS_SHARE = ['–ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫','–≤—Ç–æ—Ä–Ω–∏–∫','—Å—Ä–µ–¥–∞','—á–µ—Ç–≤–µ—Ä–≥','–ø—è—Ç–Ω–∏—Ü–∞','—Å—É–±–±–æ—Ç–∞','–≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ'];

function renderShareScreen(t) {
  const d = new Date(t.date + 'T00:00:00');
  const wd = (d.getDay() + 6) % 7;
  const dateLabel = `üìÖ ${d.getDate()} ${MONTHS_GEN_SHARE[d.getMonth()]} ${d.getFullYear()}, ${WDS_SHARE[wd]}`;

  document.getElementById('sv-name').textContent = t.name || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è';
  
  let dateText = dateLabel;
  if (t.bodyweight) {
    dateText += ` ‚Ä¢ ‚öñÔ∏è ${t.bodyweight} –∫–≥`;
  }
  document.getElementById('sv-date').textContent = dateText;

  const exContainer = document.getElementById('sv-exercises');
  exContainer.innerHTML = '';

  (t.exercises || []).forEach((ex, i) => {
    const validSets = (ex.sets || []).filter(s => s.weight || s.reps);
    const block = document.createElement('div');
    block.className = 'share-ex-block';

    let setsHTML = '';
    if (validSets.length) {
      setsHTML = `
        <div class="share-sets-header">
          <span>–°–µ—Ç</span><span>–í–µ—Å</span><span>–ü–æ–≤—Ç–æ—Ä–µ–Ω–∏—è</span>
        </div>` +
        validSets.map(s => `
        <div class="share-set-row">
          <div class="share-set-num">${s.num}</div>
          <div class="share-set-weight">${s.weight ? s.weight + ' –∫–≥' : '‚Äî'}</div>
          <div class="share-set-reps">${s.reps ? s.reps + ' –ø–æ–≤—Ç.' : '‚Äî'}</div>
        </div>`).join('');
    } else {
      setsHTML = `<div style="padding:12px 16px;font-size:13px;color:var(--text-dim)">–°–µ—Ç—ã –Ω–µ –∑–∞–ø–∏—Å–∞–Ω—ã</div>`;
    }

    block.innerHTML = `
      <div class="share-ex-title">
        <span class="share-ex-num">#${i+1}</span>${ex.name || '–£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ'}
      </div>${setsHTML}`;
    exContainer.appendChild(block);
  });

  // Note
  const noteBlock = document.getElementById('sv-note-block');
  if (t.note && t.note.trim()) {
    document.getElementById('sv-note-text').textContent = t.note;
    noteBlock.style.display = 'block';
  } else {
    noteBlock.style.display = 'none';
  }

  showScreen('share');
}

// Back button on share screen
document.getElementById('sv-back-btn').addEventListener('click', () => {
  window.location.hash = '';
  showScreen('front');
});

// ‚îÄ‚îÄ SHARE MODAL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let currentShareTraining = null;
let currentShareURL = '';
let currentShortURL = '';

// Your hosted app URL
const HOSTED_URL = 'https://dmytroskichko.github.io/DS-Gym-Diary/';

async function shortenURL(longURL) {
  try {
    const response = await fetch(`https://tinyurl.com/api-create.php?url=${encodeURIComponent(longURL)}`);
    if (response.ok) {
      return await response.text();
    }
  } catch(e) {
    console.warn('URL shortening failed', e);
  }
  return longURL; // Fallback to long URL if shortening fails
}

async function openShareModal(t) {
  currentShareTraining = t;

  // Build hash URL pointing to the hosted app
  const data = btoa(unescape(encodeURIComponent(JSON.stringify(t))));
  currentShareURL = HOSTED_URL + '#share=' + data;

  // Show loading preview
  document.getElementById('share-preview').innerHTML = `<strong>${t.name || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è'}</strong><br>–°–æ–∑–¥–∞–Ω–∏–µ —Å—Å—ã–ª–∫–∏...`;
  document.getElementById('modal-share').classList.add('show');

  // Shorten URL
  currentShortURL = await shortenURL(currentShareURL);

  // Update preview
  const d = new Date(t.date + 'T00:00:00');
  const exNames = (t.exercises || []).map(e => e.name).filter(Boolean).slice(0, 3).join(', ');
  const exMore = (t.exercises || []).length > 3 ? ` +${t.exercises.length - 3}` : '';
  document.getElementById('share-preview').innerHTML =
    `<strong>${t.name || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è'}</strong><br>` +
    `${d.getDate()} ${MONTHS_GEN_SHARE[d.getMonth()]} ${d.getFullYear()}<br>` +
    (exNames ? `–£–ø—Ä–∞–∂–Ω–µ–Ω–∏—è: ${exNames}${exMore}` : '–£–ø—Ä–∞–∂–Ω–µ–Ω–∏—è –Ω–µ –∑–∞–ø–∏—Å–∞–Ω—ã') +
    `<br><br><code style="font-size:11px;color:var(--accent2);word-break:break-all;">${currentShortURL}</code>`;
}

document.getElementById('btn-open-link').addEventListener('click', () => {
  document.getElementById('modal-share').classList.remove('show');
  if (currentShareTraining) renderShareScreen(currentShareTraining);
});

document.getElementById('modal-share-cancel').addEventListener('click', () => {
  document.getElementById('modal-share').classList.remove('show');
});

document.getElementById('modal-share').addEventListener('click', function(e) {
  if (e.target === this) this.classList.remove('show');
});

document.getElementById('btn-copy-share').addEventListener('click', () => {
  const urlToCopy = currentShortURL || currentShareURL;
  if (navigator.clipboard) {
    navigator.clipboard.writeText(urlToCopy)
      .then(() => showToast('–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!'))
      .catch(() => fallbackCopy(urlToCopy));
  } else { fallbackCopy(urlToCopy); }
});

function fallbackCopy(text) {
  const ta = document.createElement('textarea');
  ta.value = text;
  document.body.appendChild(ta);
  ta.select();
  document.execCommand('copy');
  document.body.removeChild(ta);
  showToast('–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!');
}

// ‚îÄ‚îÄ CHECK HASH ON LOAD (for shared links) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function checkHashOnLoad() {
  const hash = window.location.hash;
  if (hash.startsWith('#share=')) {
    try {
      const encoded = hash.slice(7);
      const json = decodeURIComponent(escape(atob(encoded)));
      const t = JSON.parse(json);
      renderShareScreen(t);
    } catch(e) {
      console.warn('Invalid share link', e);
    }
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SESSION SCREEN
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openSession(isEdit = false, existingTraining = null) {
  const now = new Date();
  const dateStr = isEdit ? existingTraining.date : todayStr();

  sessionState = {
    isEdit,
    trainingId: isEdit ? existingTraining.id : uid(),
    date: dateStr,
  };

  // Header
  document.getElementById('session-date-badge').textContent = formatDateFull(dateStr);

  // Name
  const nameInput = document.getElementById('session-name-input');
  nameInput.value = isEdit ? (existingTraining.name || '') : '';

  // Bodyweight
  const bodyweightInput = document.getElementById('bodyweight-input');
  bodyweightInput.value = isEdit ? (existingTraining.bodyweight || '') : '';

  // Note
  const noteArea = document.getElementById('note-area');
  const noteTa = document.getElementById('note-textarea');
  if (isEdit && existingTraining.note) {
    noteTa.value = existingTraining.note;
    noteArea.classList.add('show');
  } else {
    noteTa.value = '';
    noteArea.classList.remove('show');
  }

  // Exercises
  const container = document.getElementById('exercises-container');
  container.innerHTML = '';

  if (isEdit && existingTraining.exercises && existingTraining.exercises.length > 0) {
    existingTraining.exercises.forEach(ex => addExerciseBlock(ex));
  }

  showScreen('session');
}

// Autocomplete for training name
const sessionNameInput = document.getElementById('session-name-input');
const sessionNameAC = document.getElementById('session-name-ac');

sessionNameInput.addEventListener('input', () => {
  const val = sessionNameInput.value.trim().toLowerCase();
  if (!val) { sessionNameAC.classList.remove('show'); return; }
  const matches = appData.trainingNames.filter(n => n.toLowerCase().includes(val));
  renderACList(sessionNameAC, matches, name => {
    sessionNameInput.value = name;
    sessionNameAC.classList.remove('show');
  });
});

sessionNameInput.addEventListener('blur', () => setTimeout(() => sessionNameAC.classList.remove('show'), 200));

function renderACList(el, items, onSelect) {
  el.innerHTML = '';
  if (items.length === 0) { el.classList.remove('show'); return; }
  items.slice(0, 8).forEach(item => {
    const div = document.createElement('div');
    div.className = 'autocomplete-item';
    div.textContent = item;
    div.addEventListener('mousedown', (e) => { e.preventDefault(); onSelect(item); });
    el.appendChild(div);
  });
  el.classList.add('show');
}

// NEW EXERCISE button
document.getElementById('btn-new-exercise').addEventListener('click', () => {
  addExerciseBlock(null);
  setTimeout(() => {
    const blocks = document.querySelectorAll('.exercise-block');
    if (blocks.length) {
      const lastBlock = blocks[blocks.length - 1];
      const firstRow = lastBlock.querySelector('.set-row');
      const target = firstRow || lastBlock;
      target.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }
  }, 100);
});

// NOTE button
document.getElementById('btn-add-note').addEventListener('click', () => {
  const na = document.getElementById('note-area');
  na.classList.toggle('show');
  if (na.classList.contains('show')) document.getElementById('note-textarea').focus();
});

// ADD EXERCISE
let exerciseCounter = 0;
function addExerciseBlock(existingEx) {
  exerciseCounter++;
  const allBlocks = document.querySelectorAll('.exercise-block');
  const exNum = allBlocks.length + 1;

  const block = document.createElement('div');
  block.className = 'exercise-block';

  const exId = uid();
  block.dataset.exid = exId;

  block.innerHTML = `
    <div class="exercise-header">
      <div class="exercise-number">#${exNum}</div>
      <div class="exercise-name-wrap">
        <input type="text" class="exercise-name-input" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è" autocomplete="off" value="${existingEx ? (existingEx.name || '') : ''}">
        <div class="autocomplete-list ex-ac"></div>
      </div>
      <button class="btn-remove-exercise" title="–£–¥–∞–ª–∏—Ç—å">‚úï</button>
    </div>
    <div class="sets-table">
      <div class="sets-header">
        <span>–°–µ—Ç</span><span>–í–µ—Å (–∫–≥)</span><span>–ü–æ–≤—Ç–æ—Ä–µ–Ω–∏—è</span>
      </div>
      <div class="sets-container"></div>
    </div>`;

  const nameInput = block.querySelector('.exercise-name-input');
  const acList = block.querySelector('.ex-ac');
  const setsContainer = block.querySelector('.sets-container');
  const removeBtn = block.querySelector('.btn-remove-exercise');

  // Click exercise name to see progress
  nameInput.addEventListener('dblclick', () => {
    const name = nameInput.value.trim();
    if (name) showProgressModal(name);
  });

  // Long press on mobile
  let pressTimer;
  nameInput.addEventListener('touchstart', () => {
    pressTimer = setTimeout(() => {
      const name = nameInput.value.trim();
      if (name) showProgressModal(name);
    }, 500);
  });
  nameInput.addEventListener('touchend', () => clearTimeout(pressTimer));
  nameInput.addEventListener('touchmove', () => clearTimeout(pressTimer));

  // Exercise name autocomplete
  nameInput.addEventListener('input', () => {
    const val = nameInput.value.trim().toLowerCase();
    if (!val) { acList.classList.remove('show'); return; }
    const matches = appData.exerciseNames.filter(n => n.toLowerCase().includes(val));
    renderACList(acList, matches, name => { nameInput.value = name; acList.classList.remove('show'); });
  });
  nameInput.addEventListener('blur', () => setTimeout(() => acList.classList.remove('show'), 200));

  // Remove exercise
  removeBtn.addEventListener('click', () => {
    block.remove();
    // Renumber
    document.querySelectorAll('.exercise-block .exercise-number').forEach((el, i) => {
      el.textContent = `#${i+1}`;
    });
  });

  document.getElementById('exercises-container').appendChild(block);

  // Add sets
  if (existingEx && existingEx.sets && existingEx.sets.length > 0) {
    existingEx.sets.forEach(s => addSetRow(setsContainer, s.weight, s.reps));
  } else {
    addSetRow(setsContainer, '', '');
  }
}

function addSetRow(container, weight, reps) {
  const setNum = container.querySelectorAll('.set-row').length + 1;
  const row = document.createElement('div');
  row.className = 'set-row';

  row.innerHTML = `
    <div class="set-num">${setNum}</div>
    <input type="number" class="set-input weight-input" placeholder="‚Äî" value="${weight || ''}" inputmode="decimal" min="0" step="0.5">
    <input type="number" class="set-input reps-input" placeholder="‚Äî" value="${reps || ''}" inputmode="numeric" min="0">`;

  const weightInput = row.querySelector('.weight-input');
  const repsInput = row.querySelector('.reps-input');

  function checkAutoAdd() {
    const isLastRow = !row.nextElementSibling;
    if (isLastRow && weightInput.value.trim() && repsInput.value.trim()) {
      // Get exercise name
      const exerciseBlock = container.closest('.exercise-block');
      const exerciseName = exerciseBlock?.querySelector('.exercise-name-input')?.value?.trim();
      
      // Check for PR
      if (exerciseName) {
        const isPRSet = isPR(exerciseName, weightInput.value, repsInput.value);
        if (isPRSet) {
          showToast('üèÜ –ù–æ–≤—ã–π —Ä–µ–∫–æ—Ä–¥!');
        }
      }
      
      // Start rest timer
      startRestTimer(appData.restTimer || 90);
      
      // Add new row
      const newRow = addSetRow(container, '', '');
      // Scroll the new empty row into view smoothly
      setTimeout(() => {
        newRow.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }, 60);
    }
  }

  weightInput.addEventListener('change', checkAutoAdd);
  repsInput.addEventListener('change', checkAutoAdd);
  repsInput.addEventListener('blur', checkAutoAdd);

  container.appendChild(row);
  return row;
}

// FINISH TRAINING
document.getElementById('btn-finish-training').addEventListener('click', async () => {
  const name = document.getElementById('session-name-input').value.trim();
  const bodyweight = document.getElementById('bodyweight-input').value.trim();
  const note = document.getElementById('note-textarea').value.trim();

  const exercises = [];
  document.querySelectorAll('.exercise-block').forEach(block => {
    const exName = block.querySelector('.exercise-name-input').value.trim();
    const sets = [];
    block.querySelectorAll('.set-row').forEach((row, i) => {
      const w = row.querySelector('.weight-input').value.trim();
      const r = row.querySelector('.reps-input').value.trim();
      if (w || r) {
        sets.push({ num: i+1, weight: w, reps: r });
      }
    });
    if (exName || sets.length) {
      exercises.push({ name: exName, sets });
    }
  });

  // Update name lists
  if (name) appData.trainingNames = addToNameList(appData.trainingNames, name);
  exercises.forEach(ex => {
    if (ex.name) appData.exerciseNames = addToNameList(appData.exerciseNames, ex.name);
  });

  const training = {
    id: sessionState.trainingId,
    date: sessionState.date,
    name: name || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è',
    bodyweight: bodyweight,
    exercises,
    note,
    createdAt: Date.now(),
  };

  if (sessionState.isEdit) {
    const idx = appData.trainings.findIndex(t => t.id === sessionState.trainingId);
    if (idx !== -1) appData.trainings[idx] = training;
    else appData.trainings.push(training);
  } else {
    appData.trainings.push(training);
  }

  // Set calendar view to training month
  const td = new Date(training.date + 'T00:00:00');
  currentViewDate = new Date(td.getFullYear(), td.getMonth(), 1);

  await saveData(appData);
  renderCalendar();
  showScreen('front');
  showToast(sessionState.isEdit ? '–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞!' : '–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞!');
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CALENDAR NAVIGATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
document.getElementById('btn-prev-month').addEventListener('click', () => {
  currentViewDate.setMonth(currentViewDate.getMonth() - 1);
  renderCalendar();
});
document.getElementById('btn-next-month').addEventListener('click', () => {
  currentViewDate.setMonth(currentViewDate.getMonth() + 1);
  renderCalendar();
});

document.getElementById('btn-start-training').addEventListener('click', () => {
  openSession(false, null);
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// REST TIMER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let restTimerInterval = null;
let restTimerSeconds = 90; // default 90 seconds
let restTimerRemaining = 0;

function startRestTimer(seconds = 90) {
  stopRestTimer(); // Clear any existing timer
  restTimerSeconds = seconds;
  restTimerRemaining = seconds;
  
  const timerEl = document.getElementById('rest-timer');
  const timeEl = document.getElementById('rest-timer-time');
  
  timerEl.classList.add('show');
  updateTimerDisplay();
  
  restTimerInterval = setInterval(() => {
    restTimerRemaining--;
    updateTimerDisplay();
    
    if (restTimerRemaining <= 0) {
      stopRestTimer();
      // Beep sound (vibrate on mobile)
      if (navigator.vibrate) navigator.vibrate([200, 100, 200]);
      showToast('–û—Ç–¥—ã—Ö –∑–∞–≤–µ—Ä—à—ë–Ω!');
    }
  }, 1000);
}

function updateTimerDisplay() {
  const mins = Math.floor(restTimerRemaining / 60);
  const secs = restTimerRemaining % 60;
  document.getElementById('rest-timer-time').textContent = 
    `${mins}:${String(secs).padStart(2, '0')}`;
}

function stopRestTimer() {
  if (restTimerInterval) {
    clearInterval(restTimerInterval);
    restTimerInterval = null;
  }
  document.getElementById('rest-timer').classList.remove('show');
}

document.getElementById('rest-timer-skip').addEventListener('click', stopRestTimer);

document.getElementById('rest-timer-add').addEventListener('click', () => {
  restTimerRemaining += 30;
  updateTimerDisplay();
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PERSONAL RECORDS & PROGRESS TRACKING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function calculatePRs(exerciseName) {
  const allSets = [];
  
  appData.trainings.forEach(training => {
    training.exercises?.forEach(ex => {
      if (ex.name && ex.name.toLowerCase() === exerciseName.toLowerCase()) {
        ex.sets?.forEach(set => {
          if (set.weight && set.reps) {
            allSets.push({
              date: training.date,
              weight: parseFloat(set.weight),
              reps: parseInt(set.reps)
            });
          }
        });
      }
    });
  });
  
  if (allSets.length === 0) return null;
  
  const bestWeight = Math.max(...allSets.map(s => s.weight));
  const bestReps = Math.max(...allSets.map(s => s.reps));
  
  return { bestWeight, bestReps, allSets };
}

function isPR(exerciseName, weight, reps) {
  const prs = calculatePRs(exerciseName);
  if (!prs) return true; // First time = PR
  
  const w = parseFloat(weight);
  const r = parseInt(reps);
  
  return w >= prs.bestWeight || r >= prs.bestReps;
}

function showProgressModal(exerciseName) {
  const prs = calculatePRs(exerciseName);
  
  if (!prs || prs.allSets.length === 0) {
    showToast('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –ø–æ —ç—Ç–æ–º—É —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—é');
    return;
  }
  
  document.getElementById('progress-ex-name').textContent = exerciseName;
  document.getElementById('progress-best-weight').textContent = prs.bestWeight + ' –∫–≥';
  document.getElementById('progress-best-reps').textContent = prs.bestReps;
  
  // Sort by date
  prs.allSets.sort((a, b) => a.date.localeCompare(b.date));
  
  // Draw charts
  drawProgressChart('progress-chart-weight', prs.allSets, 'weight');
  drawProgressChart('progress-chart-reps', prs.allSets, 'reps');
  
  // Show history
  const historyList = document.getElementById('progress-history-list');
  historyList.innerHTML = '';
  
  prs.allSets.slice(-10).reverse().forEach(set => {
    const item = document.createElement('div');
    item.className = 'progress-history-item';
    const d = new Date(set.date + 'T00:00:00');
    item.innerHTML = `
      <div class="progress-history-date">${d.getDate()}.${d.getMonth()+1}.${d.getFullYear()}</div>
      <div class="progress-history-weight">${set.weight} –∫–≥</div>
      <div class="progress-history-reps">${set.reps} –ø–æ–≤—Ç.</div>
    `;
    historyList.appendChild(item);
  });
  
  document.getElementById('progress-modal').classList.add('show');
}

document.getElementById('progress-close').addEventListener('click', () => {
  document.getElementById('progress-modal').classList.remove('show');
});

document.getElementById('progress-modal').addEventListener('click', function(e) {
  if (e.target === this) this.classList.remove('show');
});

function drawProgressChart(canvasId, data, metric) {
  const canvas = document.getElementById(canvasId);
  const ctx = canvas.getContext('2d');
  const dpr = window.devicePixelRatio || 1;
  
  canvas.width = canvas.offsetWidth * dpr;
  canvas.height = canvas.offsetHeight * dpr;
  ctx.scale(dpr, dpr);
  
  const w = canvas.offsetWidth;
  const h = canvas.offsetHeight;
  
  ctx.clearRect(0, 0, w, h);
  
  if (data.length === 0) return;
  
  const values = data.map(d => metric === 'weight' ? d.weight : d.reps);
  const maxVal = Math.max(...values);
  const minVal = Math.min(...values);
  const range = maxVal - minVal || 1;
  
  const padding = 40;
  const chartW = w - padding * 2;
  const chartH = h - padding * 2;
  
  // Draw grid
  ctx.strokeStyle = '#2e3040';
  ctx.lineWidth = 1;
  for (let i = 0; i <= 4; i++) {
    const y = padding + (chartH / 4) * i;
    ctx.beginPath();
    ctx.moveTo(padding, y);
    ctx.lineTo(w - padding, y);
    ctx.stroke();
  }
  
  // Draw line
  ctx.strokeStyle = metric === 'weight' ? '#47ffb8' : '#e8ff47';
  ctx.lineWidth = 2;
  ctx.beginPath();
  
  data.forEach((point, i) => {
    const x = padding + (chartW / (data.length - 1 || 1)) * i;
    const val = metric === 'weight' ? point.weight : point.reps;
    const y = padding + chartH - ((val - minVal) / range) * chartH;
    
    if (i === 0) ctx.moveTo(x, y);
    else ctx.lineTo(x, y);
  });
  
  ctx.stroke();
  
  // Draw points
  data.forEach((point, i) => {
    const x = padding + (chartW / (data.length - 1 || 1)) * i;
    const val = metric === 'weight' ? point.weight : point.reps;
    const y = padding + chartH - ((val - minVal) / range) * chartH;
    
    ctx.fillStyle = metric === 'weight' ? '#47ffb8' : '#e8ff47';
    ctx.beginPath();
    ctx.arc(x, y, 4, 0, Math.PI * 2);
    ctx.fill();
  });
  
  // Draw labels
  ctx.fillStyle = '#8a8d9a';
  ctx.font = '11px Raleway';
  ctx.textAlign = 'right';
  
  for (let i = 0; i <= 4; i++) {
    const val = minVal + (range / 4) * (4 - i);
    const y = padding + (chartH / 4) * i;
    ctx.fillText(val.toFixed(0), padding - 8, y + 4);
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SETTINGS SCREEN
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
document.getElementById('btn-settings').addEventListener('click', () => {
  // Load current user name and rest timer
  document.getElementById('settings-user-name').value = appData.userName || '';
  document.getElementById('settings-rest-time').value = appData.restTimer || 90;
  showScreen('settings');
});

document.getElementById('settings-back-btn').addEventListener('click', () => {
  showScreen('front');
});

// Save user name on input change
document.getElementById('settings-user-name').addEventListener('input', async (e) => {
  appData.userName = e.target.value.trim();
  await saveData(appData);
  updateHeaderTitle();
});

// Save rest timer duration
document.getElementById('settings-rest-time').addEventListener('change', async (e) => {
  const val = parseInt(e.target.value);
  if (val >= 30 && val <= 600) {
    appData.restTimer = val;
    await saveData(appData);
    showToast('–í—Ä–µ–º—è –æ—Ç–¥—ã—Ö–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–æ');
  }
});

// Export button in settings
document.getElementById('settings-export-btn').addEventListener('click', () => {
  const dataStr = JSON.stringify(appData, null, 2);
  const blob = new Blob([dataStr], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  const now = new Date();
  const dateStr = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')}`;
  const userName = appData.userName?.trim() || 'user';
  const safeName = userName.replace(/[^a-zA-Z–∞-—è–ê-–Ø—ë–Å0-9]/g, '_');
  a.href = url;
  a.download = `${safeName}_training_backup_${dateStr}.json`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
  showToast('–î–∞–Ω–Ω—ã–µ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã!');
});

// Import button in settings
document.getElementById('settings-import-btn').addEventListener('click', () => {
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = '.json';
  input.onchange = async (e) => {
    const file = e.target.files[0];
    if (!file) return;
    try {
      const text = await file.text();
      const imported = JSON.parse(text);
      
      // Validate structure
      if (!imported.trainings || !Array.isArray(imported.trainings)) {
        showToast('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞');
        return;
      }

      // Merge or replace?
      if (appData.trainings.length > 0) {
        const confirmMerge = confirm('–£ –≤–∞—Å —É–∂–µ –µ—Å—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏. –û–±—ä–µ–¥–∏–Ω–∏—Ç—å —Å –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏? (–û—Ç–º–µ–Ω–∞ = –∑–∞–º–µ–Ω–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ)');
        if (confirmMerge) {
          // Merge: add imported trainings, avoiding duplicates by ID
          const existingIds = new Set(appData.trainings.map(t => t.id));
          imported.trainings.forEach(t => {
            if (!existingIds.has(t.id)) {
              appData.trainings.push(t);
            }
          });
          // Merge name lists
          imported.trainingNames?.forEach(n => {
            if (!appData.trainingNames.includes(n)) appData.trainingNames.push(n);
          });
          imported.exerciseNames?.forEach(n => {
            if (!appData.exerciseNames.includes(n)) appData.exerciseNames.push(n);
          });
          // Keep current userName unless not set
          if (!appData.userName && imported.userName) {
            appData.userName = imported.userName;
          }
        } else {
          // Replace all
          appData = imported;
        }
      } else {
        // No existing data, just import
        appData = imported;
      }

      await saveData(appData);
      document.getElementById('settings-user-name').value = appData.userName || '';
      updateHeaderTitle();
      renderCalendar();
      showToast('–î–∞–Ω–Ω—ã–µ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã!');
    } catch(err) {
      console.error('Import error:', err);
      showToast('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–º–ø–æ—Ä—Ç–µ');
    }
  };
  input.click();
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function init() {
  appData = await loadData();
  currentViewDate = new Date();
  checkHashOnLoad();
  // If no hash route matched, render the front screen normally
  if (!window.location.hash.startsWith('#share=')) {
    renderCalendar();
  }
}

init();
</script>
</body>
</html>
